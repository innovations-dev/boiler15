export const metadata = {
  title: "Email",
  description:
    "Learn about email handling and templates in Next.js 15 Boilerplate",
  section: "Features",
  order: 4,
};

Our email system uses [React Email](https://react.email) with [Resend](https://resend.com) for building and sending beautiful, type-safe transactional emails.

## Overview

- üìß **React Email**: Type-safe email templates with React
- üöÄ **Resend**: Modern email API for reliable delivery
- üé® **Tailwind CSS**: Styled components in emails
- üîç **Preview Mode**: Local development preview
- üì± **Responsive**: Mobile-friendly email templates
- ‚ö° **Rate Limiting**: Built-in protection against abuse
- üîí **Type Safety**: Full TypeScript support
- üéØ **Error Handling**: Robust error management
- üìä **Logging**: Comprehensive activity tracking

## Configuration

The email system is configured in `lib/email/config.ts`:

```ts
export const emailConfig = {
  from: env.EMAIL_FROM,
  replyTo: env.EMAIL_FROM,
  baseUrl: env.NEXT_PUBLIC_APP_URL,
  templates: {
    MAGIC_LINK: {
      subject: "Login to your account",
      expiresIn: "15 minutes",
    },
    VERIFICATION: {
      subject: "Verify your email address",
      expiresIn: "24 hours",
    },
    INVITATION: {
      subject: "Invitation to join {organizationName}",
      expiresIn: "48 hours",
    },
    RESET_PASSWORD: {
      subject: "Reset your password",
      expiresIn: "30 minutes",
    },
    EMAIL_CHANGE: {
      subject: "Confirm your new email address",
      expiresIn: "1 hour",
    },
  },
  rateLimits: {
    maxPerHour: 10,
    maxPerDay: 50,
  },
};
```

## Type Definitions

Our email system uses TypeScript for type safety:

```ts
export type EmailTemplate =
  | "MAGIC_LINK"
  | "VERIFICATION"
  | "INVITATION"
  | "RESET_PASSWORD"
  | "EMAIL_CHANGE";

export interface EmailOptions {
  to: string;
  subject: string;
  template: EmailTemplate;
  data: Record<string, unknown>;
}

export interface EmailResult {
  success: boolean;
  data?: unknown;
  error?: EmailError;
}
```

## Email Service

Our email service (`lib/email/services/email-service.ts`) provides a type-safe way to send templated emails:

```ts
export async function sendEmail(options: EmailOptions): Promise<EmailResult> {
  try {
    const template = templateComponents[options.template];
    const templateConfig = emailConfig.templates[options.template];
    const element = createElement(template, options.data);
    const html = await render(element);

    const result = await resend.emails.send({
      from: emailConfig.from,
      to: options.to,
      subject: templateConfig.subject.replace(
        /{(\w+)}/g,
        (_, key) => options.data[key] as string
      ),
      html,
    });

    return { success: true, data: result };
  } catch (error) {
    if (error instanceof Error && error.message.includes("rate limit")) {
      throw new EmailRateLimitError("Email rate limit exceeded");
    }
    throw new EmailDeliveryError("Failed to send email", error);
  }
}
```

## Email Templates

### Authentication Emails

1. **Magic Link Email** (`emails/magic-link.tsx`):

   - Purpose: Passwordless authentication
   - Expiry: 15 minutes
   - Features: Responsive design, security warnings

2. **Verification Email** (`emails/verification-email.tsx`):

   - Purpose: Email verification
   - Expiry: 24 hours
   - Features: Clear CTA, security information

3. **Reset Password Email** (`emails/reset-password.tsx`):
   - Purpose: Password reset
   - Expiry: 30 minutes
   - Features: Expiry time display, one-time use warning

### Organization Emails

1. **Invitation Email** (`emails/invitation.tsx`):
   - Purpose: Organization invitations
   - Expiry: 48 hours
   - Features: Organization context, inviter information

### Common Template Features

All email templates include:

- Responsive design with Tailwind CSS
- Company branding and logo
- Clear call-to-action buttons
- Security warnings and disclaimers
- Footer with legal links
- ARIA labels for accessibility
- Mobile-optimized layout

## Error Handling

Our system includes robust error handling:

```ts
export class EmailError extends Error {
  constructor(
    message: string,
    public cause?: unknown
  ) {
    super(message);
    this.name = "EmailError";
  }
}

export class EmailRateLimitError extends EmailError {
  constructor(message: string) {
    super(message);
    this.name = "EmailRateLimitError";
  }
}

export class EmailDeliveryError extends EmailError {
  constructor(message: string, cause?: unknown) {
    super(message, cause);
    this.name = "EmailDeliveryError";
  }
}
```

## Usage Examples

### Sending Authentication Emails

```ts
// Magic Link Authentication
await sendEmail({
  to: user.email,
  template: "MAGIC_LINK",
  subject: "Login to your account",
  data: {
    url: magicLinkUrl,
  },
});

// Password Reset
await sendEmail({
  to: user.email,
  template: "RESET_PASSWORD",
  subject: "Reset your password",
  data: {
    url: resetUrl,
    expiryTime: new Date(Date.now() + 30 * 60 * 1000).toISOString(),
  },
});
```

### Sending Organization Invites

```ts
await sendEmail({
  to: inviteeEmail,
  template: "INVITATION",
  subject: `Invitation to join ${org.name}`,
  data: {
    url: inviteUrl,
    organizationName: org.name,
    invitedByUsername: inviter.name,
  },
});
```

## Development

### Local Email Preview

Start the email preview server:

```bash
pnpm mail:dev
```

This starts a local server at `http://localhost:3001` where you can preview your email templates.

### Testing Emails

For testing, we recommend:

1. Using the preview server during development
2. Setting up a test email account in your `.env`:
   ```
   TEST_EMAIL=your-test@email.com
   ```
3. Using Resend's test mode for integration testing

## Best Practices

1. **Rate Limiting**

   - Implement per-user and global rate limits
   - Use exponential backoff for retries
   - Monitor usage patterns

2. **Security**

   - Never expose sensitive data in emails
   - Use short-lived tokens
   - Implement click tracking
   - Log all email activities

3. **Accessibility**

   - Use semantic HTML
   - Include text alternatives
   - Test with screen readers
   - Maintain color contrast

4. **Error Handling**

   - Implement proper error boundaries
   - Log failed attempts
   - Provide user-friendly error messages
   - Handle rate limits gracefully

5. **Performance**
   - Optimize images
   - Minimize HTML size
   - Use async sending
   - Implement retries with backoff

## Environment Variables

Required environment variables:

```bash
RESEND_API_KEY=re_xxxx # Your Resend API key
EMAIL_FROM=noreply@yourdomain.com # Verified sender email
NEXT_PUBLIC_APP_URL=https://yourdomain.com # Your app's URL
```

## Next Steps

- [Authentication](/docs/features/authentication) - Email in authentication flows
- [Organizations](/docs/features/organizations) - Team and invite management
- [Testing](/docs/guides/testing) - Testing email functionality
