export const metadata = {
  title: "Email",
  description:
    "Learn about email handling and templates in Next.js 15 Boilerplate",
  section: "Features",
  order: 4,
};

Our email system uses [React Email](https://react.email) with [Resend](https://resend.com) for building and sending beautiful, type-safe transactional emails.

## Overview

- üìß **React Email**: Type-safe email templates with React
- üöÄ **Resend**: Modern email API for reliable delivery
- üé® **Tailwind CSS**: Styled components in emails
- üîç **Preview Mode**: Local development preview
- üì± **Responsive**: Mobile-friendly email templates

## Configuration

The email system is configured in `lib/email/config.ts`:

```ts
import { env } from "@/env";

export const emailConfig = {
  from: env.EMAIL_FROM,
  replyTo: env.EMAIL_FROM,
  baseUrl: env.NEXT_PUBLIC_APP_URL,
};
```

## Email Templates

### Authentication Emails

1. **Magic Link Email** (`emails/magic-link.tsx`):

```tsx
export default function MagicLinkEmail({ url }: MagicLinkEmailProps) {
  return (
    <Html>
      <Head />
      <Preview>Your login link for the application</Preview>
      <Tailwind config={tailwindConfig}>
        <Body className="bg-[#f6f9fc] font-sans">
          <Container className="mx-auto my-[40px] w-full max-w-3xl rounded border border-solid border-[#eaeaea] bg-white p-5">
            <Section className="mt-[32px]">
              <Img
                src={`${baseUrl}/logo.png`}
                width="40"
                height="40"
                alt="Logo"
                className="mx-auto"
              />
            </Section>
            <Heading className="mx-0 my-[30px] p-0 text-center text-[24px] font-normal text-[#484848]">
              Login to Your Account
            </Heading>
            <Text className="m-0 mb-4 text-center text-base leading-[24px] text-[#484848]">
              Click the button below to sign in to your account.
            </Text>
            <Section className="mb-8 text-center">
              <Button href={url}>Sign In</Button>
            </Section>
          </Container>
        </Body>
      </Tailwind>
    </Html>
  );
}
```

2. **Verification Email** (`emails/verification-email.tsx`):

```tsx
export default function VerificationEmail({ url }: VerificationEmailProps) {
  return (
    <Html>
      <Head />
      <Preview>Verify your email address</Preview>
      <Tailwind config={tailwindConfig}>
        <Body className="bg-[#f6f9fc] font-sans">
          <Container>
            <Heading>Verify Your Email Address</Heading>
            <Text>Click the button below to verify your email address.</Text>
            <Button href={url}>Verify Email</Button>
          </Container>
        </Body>
      </Tailwind>
    </Html>
  );
}
```

### Organization Emails

1. **Invitation Email** (`emails/invitation.tsx`):

```tsx
export default function InvitationEmail({
  url,
  organizationName,
  invitedByUsername,
}: InvitationEmailProps) {
  return (
    <Html>
      <Head />
      <Preview>Invitation to join {organizationName}</Preview>
      <Tailwind config={tailwindConfig}>
        <Body className="bg-[#f6f9fc] font-sans">
          <Container>
            <Heading>Invitation to join {organizationName}</Heading>
            <Text>
              You have been invited to join {organizationName} by{" "}
              {invitedByUsername}.
            </Text>
            <Button href={url}>Accept Invitation</Button>
          </Container>
        </Body>
      </Tailwind>
    </Html>
  );
}
```

## Email Service

Our email sending service is implemented in `lib/email/services/send-email.ts`:

```ts
import { Resend } from "resend";

import { env } from "@/env";

const resend = new Resend(env.RESEND_API_KEY);

export async function sendEmailWithRetry({
  to,
  subject,
  html,
  retries = 3,
}: {
  to: string;
  subject: string;
  html: string;
  retries?: number;
}) {
  try {
    await resend.emails.send({
      from: env.EMAIL_FROM,
      to,
      subject,
      html,
    });
  } catch (error) {
    if (retries > 0) {
      await new Promise((resolve) => setTimeout(resolve, 1000));
      return sendEmailWithRetry({ to, subject, html, retries: retries - 1 });
    }
    throw error;
  }
}
```

## Usage Examples

### Sending Authentication Emails

```ts
import { getMagicLinkEmail } from "@/emails/magic-link";
import { sendEmailWithRetry } from "@/lib/email/services/send-email";

export async function sendMagicLink({
  email,
  url,
}: {
  email: string;
  url: string;
}) {
  await sendEmailWithRetry({
    to: email,
    subject: "Login to your account",
    html: await getMagicLinkEmail(url),
  });
}
```

### Sending Organization Invites

```ts
import { getInvitationEmail } from "@/emails/invitation";
import { sendEmailWithRetry } from "@/lib/email/services/send-email";

export async function sendOrganizationInvite({
  email,
  organizationName,
  invitedByUsername,
  inviteUrl,
}: {
  email: string;
  organizationName: string;
  invitedByUsername: string;
  inviteUrl: string;
}) {
  await sendEmailWithRetry({
    to: email,
    subject: `Invitation to join ${organizationName}`,
    html: await getInvitationEmail({
      url: inviteUrl,
      organizationName,
      invitedByUsername,
    }),
  });
}
```

## Development

### Local Email Preview

Start the email preview server:

```bash
pnpm mail:dev
```

This starts a local server at `http://localhost:3001` where you can preview your email templates.

### Testing Emails

For testing, we recommend:

1. Using the preview server during development
2. Setting up a test email account in your `.env`:
   ```
   TEST_EMAIL=your-test@email.com
   ```
3. Using Resend's test mode for integration testing

## Best Practices

1. **Error Handling**

```ts
try {
  await sendEmailWithRetry({
    to: email,
    subject,
    html,
  });
} catch (error) {
  console.error("Failed to send email:", error);
  // Handle the error appropriately
}
```

2. **Template Organization**

- Keep email templates in the `emails/` directory
- Use TypeScript for type safety
- Implement responsive designs
- Test across email clients

3. **Rate Limiting**

```ts
import { rateLimit } from "@/lib/utils";

const emailRateLimiter = rateLimit({
  interval: 60 * 1000, // 1 minute
  maxRequests: 10,
});

async function sendRateLimitedEmail(to: string) {
  await emailRateLimiter.check();
  await sendEmailWithRetry({ to, subject, html });
}
```

## Next Steps

- [Authentication](/docs/features/authentication) - Email in authentication flows
- [Organizations](/docs/features/organizations) - Team and invite management
- [Testing](/docs/guides/testing) - Testing email functionality
